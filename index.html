<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive school dashboard with schedule tracking, weather, and useful daily information.">
    <meta name="keywords" content="school schedule, dashboard, period tracker, weather, daily planner">
    <meta name="author" content="School Dashboard">
    <title>School Dashboard</title>
    
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📚</text></svg>">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            transition: background 1s ease;
            overflow-x: hidden;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 20px;
            height: calc(100vh - 40px);
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow: hidden;
            position: relative;
        }
        
        .card h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            opacity: 0.8;
            font-weight: 300;
        }
        
        .schedule-card {
            grid-column: 2;
            grid-row: 2;
        }
        
        .status {
            font-size: clamp(1.5em, 3vw, 2em);
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }
        
        .countdown {
            font-size: clamp(2em, 4vw, 2.5em);
            font-weight: bold;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin: 10px 0;
            line-height: 1.1;
        }
        
        .period-info {
            font-size: clamp(1em, 2vw, 1.2em);
            margin: 5px 0;
            opacity: 0.9;
        }
        
        .next-info {
            font-size: clamp(0.9em, 2vw, 1.1em);
            margin-top: 10px;
            color: #81c784;
            font-weight: bold;
        }
        
        .before-after {
            font-size: clamp(2.5em, 5vw, 3em);
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            line-height: 1;
        }
        
        .weather-info {
            font-size: clamp(1em, 2vw, 1.2em);
            margin: 5px 0;
            color: #b3e5fc;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .weather-temp {
            font-weight: bold;
            color: #ffeb3b;
        }
        
        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .card-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .large-text {
            font-size: clamp(1.5em, 3vw, 2em);
            font-weight: bold;
            margin: 5px 0;
        }
        
        .medium-text {
            font-size: clamp(1.1em, 2.5vw, 1.4em);
            margin: 3px 0;
        }
        
        .small-text {
            font-size: clamp(0.8em, 1.8vw, 1em);
            opacity: 0.8;
            margin: 2px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 4px;
            transition: width 1s ease;
        }
        
        .news-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            margin: 3px 0;
            font-size: 0.85em;
            line-height: 1.3;
            width: 100%;
        }
        
        .holiday-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .timezone-item {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 3px 0;
            font-size: 0.9em;
        }
        
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .settings-modal {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .settings-header {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .settings-section {
            margin-bottom: 25px;
        }
        
        .settings-section h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #81c784;
        }
        
        .period-input {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
            flex-wrap: nowrap;
        }
        
        .period-input label {
            width: 100px;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        
        .period-input input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 5px 10px;
            color: white;
            width: 70px;
            flex-shrink: 0;
        }
        
        .city-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 10px;
            color: white;
            font-size: 1em;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .preset-btn {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #bbdefb;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .preset-btn:hover {
            background: rgba(33, 150, 243, 0.4);
        }
        
        .settings-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-save {
            background: #4caf50;
            color: white;
        }
        
        .btn-cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            color: #ffcdd2;
            font-size: 0.9em;
            display: none;
        }
        
        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            color: #c8e6c9;
            font-size: 0.9em;
            display: none;
        }
        
        /* Checkbox styling */
        input[type="checkbox"] {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
        }
        
        input[type="checkbox"]:checked {
            background: #4caf50;
            border-color: #4caf50;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(9, minmax(120px, 1fr));
                gap: 15px;
                height: auto;
            }
            
            .schedule-card {
                grid-column: 1;
                grid-row: 5;
            }
            
            .card {
                padding: 15px;
            }
            
            .settings-btn {
                position: fixed;
                top: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 1.1em;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard {
                gap: 10px;
            }
            
            .card {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <button class="settings-btn" onclick="openSettings()" aria-label="Open Settings">⚙️</button>
    
    <div class="dashboard">
        <!-- Row 1 -->
        <div class="card">
            <div class="card-content" id="dateCard">
                <h3>Today</h3>
            </div>
        </div>
        
        <div class="card">
            <div class="card-content" id="weatherCard">
                <h3>Weather</h3>
            </div>
        </div>
        
        <div class="card">
            <div class="card-content" id="sunCard">
                <h3>Sun & Moon</h3>
            </div>
        </div>
        
        <!-- Row 2 -->
        <div class="card">
            <div class="card-content" id="timezoneCard">
                <h3>Time Zones</h3>
            </div>
        </div>
        
        <div class="card schedule-card">
            <div class="card-content" id="scheduleCard">
                <div id="display"></div>
                <div class="small-text" id="currentTime"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-content" id="holidayCard">
                <h3>Today's Special</h3>
            </div>
        </div>
        
        <!-- Row 3 -->
        <div class="card">
            <div class="card-content" id="progressCard">
                <h3>Day Progress</h3>
            </div>
        </div>
        
        <div class="card">
            <div class="card-content" id="statsCard">
                <h3>Quick Stats</h3>
            </div>
        </div>
        
        <div class="card">
            <div class="card-content" id="newsCard">
                <h3>Administration</h3>
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay" role="dialog" aria-hidden="true">
        <div class="settings-modal">
            <div class="settings-header">Settings</div>
            
            <div class="settings-section">
                <h3>Weather Location</h3>
                <input type="text" class="city-input" id="cityInput" 
                       placeholder="Enter location (e.g., New York NY, 10001, London)" 
                       value="New York, NY" aria-label="Weather location">
                <div class="error-message" id="weatherError" role="alert"></div>
            </div>
            
            <div class="settings-section">
                <h3>Card Appearance</h3>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="dynamicCardsToggle" style="transform: scale(1.2);">
                    <span>Dynamic card colors (shuffle every 30 seconds)</span>
                </label>
                <div class="small-text" style="opacity: 0.7; margin-left: 32px;">
                    When disabled, cards will remain translucent
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Schedule Presets</h3>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="applyPreset('normal')">Normal</button>
                    <button class="preset-btn" onclick="applyPreset('homeroom')">Homeroom</button>
                    <button class="preset-btn" onclick="applyPreset('extendedHomeroom')">Extended Homeroom</button>
                    <button class="preset-btn" onclick="applyPreset('meeting')">Meeting</button>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Custom Period Schedule</h3>
                <div id="scheduleInputs"></div>
                <div class="error-message" id="scheduleError" role="alert"></div>
                <div class="success-message" id="successMessage" role="status"></div>
            </div>
            
            <div class="settings-buttons">
                <button class="btn btn-save" onclick="saveSettings()">Save</button>
                <button class="btn btn-cancel" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-cancel" onclick="exportSettings()" style="background: #2196f3;">Export</button>
                <button class="btn btn-cancel" onclick="importSettings()" style="background: #ff9800;">Import</button>
                <button class="btn btn-cancel" onclick="resetSettings()" style="background: #f44336;">Reset All</button>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        
        const APP_VERSION = '2.0.0';
        const STORAGE_KEY = 'schoolDashboardSettings';
        
        // Default settings and presets (same as before)
        const DEFAULT_SETTINGS = {
            city: "New York, NY",
            schedule: [
                { name: "Before school", start: "00:00", end: "08:00", type: "before" },
                { name: "Period 1", start: "08:00", end: "08:41", type: "period" },
                { name: "Period 2", start: "08:45", end: "09:26", type: "period" },
                { name: "Period 3", start: "09:31", end: "10:15", type: "period" },
                { name: "Period 4", start: "10:20", end: "11:01", type: "period" },
                { name: "Period 5", start: "11:06", end: "11:47", type: "period" },
                { name: "Period 6", start: "11:52", end: "12:33", type: "period" },
                { name: "Period 7", start: "12:38", end: "13:19", type: "period" },
                { name: "Period 8", start: "13:24", end: "14:05", type: "period" },
                { name: "Period 9", start: "14:09", end: "14:50", type: "period" },
                { name: "Period 10", start: "14:54", end: "15:35", type: "period" },
                { name: "After school", start: "15:35", end: "23:59", type: "after" }
            ]
        };

        const PRESET_SCHEDULES = {
            normal: {
                name: "Normal Schedule",
                schedule: [
                    { name: "Before school", start: "00:00", end: "08:00", type: "before" },
                    { name: "Period 1", start: "08:00", end: "08:41", type: "period" },
                    { name: "Period 2", start: "08:45", end: "09:26", type: "period" },
                    { name: "Period 3", start: "09:31", end: "10:15", type: "period" },
                    { name: "Period 4", start: "10:20", end: "11:01", type: "period" },
                    { name: "Period 5", start: "11:06", end: "11:47", type: "period" },
                    { name: "Period 6", start: "11:52", end: "12:33", type: "period" },
                    { name: "Period 7", start: "12:38", end: "13:19", type: "period" },
                    { name: "Period 8", start: "13:24", end: "14:05", type: "period" },
                    { name: "Period 9", start: "14:09", end: "14:50", type: "period" },
                    { name: "Period 10", start: "14:54", end: "15:35", type: "period" },
                    { name: "After school", start: "15:35", end: "23:59", type: "after" }
                ]
            },
            homeroom: {
                name: "Homeroom Schedule",
                schedule: [
                    { name: "Before school", start: "00:00", end: "08:00", type: "before" },
                    { name: "Period 1", start: "08:00", end: "08:40", type: "period" },
                    { name: "Period 2", start: "08:45", end: "09:25", type: "period" },
                    { name: "Period 3", start: "09:29", end: "10:09", type: "period" },
                    { name: "Homeroom", start: "10:13", end: "10:25", type: "period" },
                    { name: "Period 4", start: "10:30", end: "11:10", type: "period" },
                    { name: "Period 5", start: "11:14", end: "11:54", type: "period" },
                    { name: "Period 6", start: "11:58", end: "12:38", type: "period" },
                    { name: "Period 7", start: "12:42", end: "13:22", type: "period" },
                    { name: "Period 8", start: "13:26", end: "14:06", type: "period" },
                    { name: "Period 9", start: "14:10", end: "14:50", type: "period" },
                    { name: "Period 10", start: "14:55", end: "15:35", type: "period" },
                    { name: "After school", start: "15:35", end: "23:59", type: "after" }
                ]
            },
            extendedHomeroom: {
                name: "Extended Homeroom",
                schedule: [
                    { name: "Before school", start: "00:00", end: "08:00", type: "before" },
                    { name: "Period 1", start: "08:00", end: "08:41", type: "period" },
                    { name: "Period 2", start: "08:45", end: "09:25", type: "period" },
                    { name: "Period 3", start: "09:29", end: "10:08", type: "period" },
                    { name: "Homeroom", start: "10:12", end: "10:33", type: "period" },
                    { name: "Period 4", start: "10:37", end: "11:16", type: "period" },
                    { name: "Period 5", start: "11:20", end: "11:59", type: "period" },
                    { name: "Period 6", start: "12:03", end: "12:42", type: "period" },
                    { name: "Period 7", start: "12:46", end: "13:25", type: "period" },
                    { name: "Period 8", start: "13:29", end: "14:08", type: "period" },
                    { name: "Period 9", start: "14:12", end: "14:51", type: "period" },
                    { name: "Period 10", start: "14:55", end: "15:35", type: "period" },
                    { name: "After school", start: "15:35", end: "23:59", type: "after" }
                ]
            },
            meeting: {
                name: "Meeting Schedule",
                schedule: [
                    { name: "Before school", start: "00:00", end: "08:00", type: "before" },
                    { name: "Period 1", start: "08:00", end: "08:37", type: "period" },
                    { name: "Period 2", start: "08:41", end: "09:18", type: "period" },
                    { name: "Period 3", start: "09:22", end: "09:59", type: "period" },
                    { name: "Period 4", start: "10:03", end: "10:40", type: "period" },
                    { name: "Period 5", start: "10:44", end: "11:21", type: "period" },
                    { name: "Period 6", start: "11:25", end: "12:02", type: "period" },
                    { name: "Period 7", start: "12:06", end: "12:43", type: "period" },
                    { name: "Period 8", start: "12:47", end: "13:24", type: "period" },
                    { name: "Period 9", start: "13:28", end: "14:05", type: "period" },
                    { name: "Period 10", start: "14:09", end: "14:46", type: "period" },
                    { name: "Meeting", start: "14:50", end: "15:30", type: "period" },
                    { name: "After school", start: "15:30", end: "23:59", type: "after" }
                ]
            }
        };

        let userSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
        let weatherData = { temp: '...', description: 'Loading...', loading: true, error: false };

        // Card color system
        const cardColors = [
            'rgba(255, 99, 132, 0.3)',   // Red
            'rgba(54, 162, 235, 0.3)',   // Blue  
            'rgba(255, 205, 86, 0.3)',   // Yellow
            'rgba(75, 192, 192, 0.3)',   // Teal
            'rgba(153, 102, 255, 0.3)',  // Purple
            'rgba(255, 159, 64, 0.3)',   // Orange
            'rgba(199, 199, 199, 0.3)',  // Gray
            'rgba(83, 102, 255, 0.3)',   // Indigo
            'rgba(255, 99, 255, 0.3)',   // Pink
            'rgba(102, 255, 178, 0.3)',  // Green
            'rgba(255, 178, 102, 0.3)',  // Peach
            'rgba(178, 102, 255, 0.3)',  // Lavender
        ];

        const defaultCardColor = 'rgba(255, 255, 255, 0.1)'; // Original translucent

        // Utility functions
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatCountdown(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function getDayName() {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[new Date().getDay()];
        }

        function getMonthName() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[new Date().getMonth()];
        }

        function interpolateColor(color1, color2, factor) {
            const hex1 = color1.replace('#', '');
            const hex2 = color2.replace('#', '');
            
            const r1 = parseInt(hex1.substr(0, 2), 16);
            const g1 = parseInt(hex1.substr(2, 2), 16);
            const b1 = parseInt(hex1.substr(4, 2), 16);
            
            const r2 = parseInt(hex2.substr(0, 2), 16);
            const g2 = parseInt(hex2.substr(2, 2), 16);
            const b2 = parseInt(hex2.substr(4, 2), 16);
            
            const r = Math.round(r1 + (r2 - r1) * factor);
            const g = Math.round(g1 + (g2 - g1) * factor);
            const b = Math.round(b1 + (b2 - b1) * factor);
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        // Settings management (same as before)
        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsedSettings = JSON.parse(saved);
                    if (parsedSettings.city) userSettings.city = parsedSettings.city;
                    if (parsedSettings.schedule && Array.isArray(parsedSettings.schedule)) {
                        const requiredPeriods = ['Before school', 'Period 1', 'Period 2', 'Period 3', 'Period 4', 'Period 5', 'Period 6', 'Period 7', 'Period 8', 'Period 9', 'Period 10', 'After school'];
                        let validSchedule = true;
                        for (let periodName of requiredPeriods) {
                            if (!parsedSettings.schedule.find(p => p.name === periodName)) {
                                validSchedule = false;
                                break;
                            }
                        }
                        if (validSchedule) userSettings.schedule = parsedSettings.schedule;
                    }
                }
            } catch (error) {
                console.warn('Error loading settings, using defaults:', error);
            }
        }

        function saveSettingsToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(userSettings));
                return true;
            } catch (error) {
                console.error('Error saving settings:', error);
                return false;
            }
        }

        function clearSavedSettings() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                return true;
            } catch (error) {
                console.error('Error clearing settings:', error);
                return false;
            }
        }

        // Schedule functions
        function generateFullSchedule() {
            const fullSchedule = [];
            const periods = userSettings.schedule.filter(p => p.type === 'period');
            
            fullSchedule.push(userSettings.schedule.find(p => p.type === 'before'));
            
            for (let i = 0; i < periods.length; i++) {
                fullSchedule.push(periods[i]);
                if (i < periods.length - 1) {
                    const currentEnd = periods[i].end;
                    const nextStart = periods[i + 1].start;
                    const nextPeriodName = periods[i + 1].name;
                    
                    fullSchedule.push({
                        name: "Passing",
                        start: currentEnd,
                        end: nextStart,
                        type: "passing",
                        next: nextPeriodName
                    });
                }
            }
            
            fullSchedule.push(userSettings.schedule.find(p => p.type === 'after'));
            return fullSchedule;
        }

        function getCurrentPeriod() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const schedule = generateFullSchedule();
            
            for (let period of schedule) {
                const startMinutes = timeToMinutes(period.start);
                const endMinutes = timeToMinutes(period.end);
                
                if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
                    return period;
                }
            }
            return null;
        }

        // Weather functions
        function generateSmartMockWeather(location) {
            const now = new Date();
            const month = now.getMonth();
            const day = now.getDate();
            
            let seed = 0;
            for (let i = 0; i < location.length; i++) {
                seed += location.charCodeAt(i);
            }
            seed += day + month * 31;
            
            function seededRandom() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            }
            
            const monthlyTemps = [32, 38, 48, 58, 68, 78, 82, 80, 72, 62, 48, 36];
            let baseTemp = monthlyTemps[month];
            
            const locationLower = location.toLowerCase();
            if (locationLower.includes('florida') || locationLower.includes('miami') || locationLower.includes('phoenix')) {
                baseTemp += 15;
            } else if (locationLower.includes('alaska') || locationLower.includes('minnesot') || locationLower.includes('maine')) {
                baseTemp -= 15;
            } else if (locationLower.includes('california') || locationLower.includes('san diego')) {
                baseTemp += 8;
            } else if (locationLower.includes('texas') || locationLower.includes('arizona')) {
                baseTemp += 10;
            }
            
            const tempVariation = Math.floor(seededRandom() * 16) - 8;
            const finalTemp = Math.max(0, baseTemp + tempVariation);
            
            const conditions = ['Clear', 'Partly Cloudy', 'Cloudy', 'Light Rain', 'Sunny'];
            const winterConditions = ['Cloudy', 'Snow', 'Clear', 'Overcast', 'Light Snow'];
            
            let weatherConditions = month >= 11 || month <= 2 ? winterConditions : conditions;
            if (baseTemp > 75) weatherConditions = ['Sunny', 'Clear', 'Partly Cloudy', 'Hot'];
            
            const conditionIndex = Math.floor(seededRandom() * weatherConditions.length);
            const condition = weatherConditions[conditionIndex];
            
            return {
                temp: `${finalTemp}°F`,
                description: condition
            };
        }

        async function fetchWeather() {
            const originalCity = userSettings.city.trim();
            if (!originalCity) {
                weatherData = { temp: 'Error', description: 'No city specified', loading: false, error: true };
                return;
            }

            const weatherServices = [
                async () => {
                    const response = await fetch(`https://wttr.in/${encodeURIComponent(originalCity)}?format=3`);
                    const text = await response.text();
                    if (text && text.includes('°')) {
                        const parts = text.split(':');
                        if (parts.length >= 2) {
                            return {
                                temp: parts[1].split(' ')[1] || 'N/A',
                                description: parts[1].split(' ').slice(2).join(' ') || 'Clear'
                            };
                        }
                    }
                    throw new Error('Invalid response format');
                },
                async () => {
                    const response = await fetch(`https://wttr.in/${encodeURIComponent(originalCity)}?format=%t`);
                    const temp = await response.text();
                    if (temp && temp.includes('°')) {
                        const response2 = await fetch(`https://wttr.in/${encodeURIComponent(originalCity)}?format=%C`);
                        const condition = await response2.text();
                        return { temp: temp.trim(), description: condition.trim() || 'Clear' };
                    }
                    throw new Error('Invalid temperature format');
                }
            ];

            for (let i = 0; i < weatherServices.length; i++) {
                try {
                    const result = await weatherServices[i]();
                    weatherData = { temp: result.temp, description: result.description, loading: false, error: false };
                    return;
                } catch (error) {
                    // Continue to next service
                }
            }
            
            const mockWeather = generateSmartMockWeather(originalCity);
            weatherData = { temp: mockWeather.temp, description: mockWeather.description, loading: false, error: false };
        }

        // Background color management
        function updateBackgroundColor(currentPeriod) {
            const body = document.body;
            
            if (currentPeriod && currentPeriod.type === 'period') {
                const now = new Date();
                const startMinutes = timeToMinutes(currentPeriod.start);
                const endMinutes = timeToMinutes(currentPeriod.end);
                const currentMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
                
                const progress = Math.max(0, Math.min(1, (currentMinutes - startMinutes) / (endMinutes - startMinutes)));
                
                const startColor1 = '#667eea';
                const startColor2 = '#764ba2';
                const endColor1 = '#ff6b6b';
                const endColor2 = '#c44569';
                
                const color1 = interpolateColor(startColor1, endColor1, progress);
                const color2 = interpolateColor(startColor2, endColor2, progress);
                
                body.style.background = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            } else {
                body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        // Card color management
        function shuffleCardColors() {
            if (!userSettings.dynamicCards) {
                // Reset to static translucent
                const cards = document.querySelectorAll('.card');
                cards.forEach(card => {
                    card.style.background = defaultCardColor;
                });
                return;
            }

            const cards = document.querySelectorAll('.card');
            const shuffledColors = [...cardColors].sort(() => Math.random() - 0.5);
            
            cards.forEach((card, index) => {
                const colorIndex = index % shuffledColors.length;
                card.style.background = shuffledColors[colorIndex];
                card.style.transition = 'background 2s ease-in-out';
            });
        }

        function applyCardColorSetting() {
            if (userSettings.dynamicCards) {
                shuffleCardColors(); // Apply colors immediately
            } else {
                // Reset to static
                const cards = document.querySelectorAll('.card');
                cards.forEach(card => {
                    card.style.background = defaultCardColor;
                    card.style.transition = 'background 1s ease-in-out';
                });
            }
        }

        // Card update functions
        function getCurrentScheduleType() {
            // Compare current schedule with presets to determine type
            const currentPeriods = userSettings.schedule.filter(p => p.type === 'period');
            
            for (const [key, preset] of Object.entries(PRESET_SCHEDULES)) {
                const presetPeriods = preset.schedule.filter(p => p.type === 'period');
                
                // Check if schedules match exactly
                if (currentPeriods.length === presetPeriods.length) {
                    let matches = true;
                    for (let i = 0; i < currentPeriods.length; i++) {
                        const current = currentPeriods[i];
                        const presetPeriod = presetPeriods[i];
                        
                        if (current.name !== presetPeriod.name || 
                            current.start !== presetPeriod.start || 
                            current.end !== presetPeriod.end) {
                            matches = false;
                            break;
                        }
                    }
                    
                    if (matches) {
                        switch (key) {
                            case 'normal': return 'NORMAL';
                            case 'homeroom': return 'HOMEROOM';
                            case 'extendedHomeroom': return 'EXTENDED HOMEROOM';
                            case 'meeting': return 'MEETING';
                        }
                    }
                }
            }
            
            return null; // Custom schedule, don't show type
        }

        function updateDateCard() {
            const now = new Date();
            const dateCard = document.getElementById('dateCard');
            const scheduleType = getCurrentScheduleType();
            
            if (scheduleType) {
                dateCard.innerHTML = `
                    <h3>Today</h3>
                    <div class="large-text">${getDayName()}</div>
                    <div class="medium-text">${getMonthName()} ${now.getDate()}</div>
                    <div class="small-text">${now.getFullYear()}</div>
                    <div class="small-text" style="color: #81c784; margin-top: 8px;">${scheduleType}</div>
                `;
            } else {
                dateCard.innerHTML = `
                    <h3>Today</h3>
                    <div class="large-text">${getDayName()}</div>
                    <div class="medium-text">${getMonthName()} ${now.getDate()}</div>
                    <div class="small-text">${now.getFullYear()}</div>
                `;
            }
        }

        function updateWeatherCard() {
            const weatherCard = document.getElementById('weatherCard');
            
            if (weatherData.loading) {
                weatherCard.innerHTML = `
                    <h3>Weather</h3>
                    <div class="medium-text">Loading...</div>
                `;
            } else if (weatherData.error) {
                weatherCard.innerHTML = `
                    <h3>Weather</h3>
                    <div class="small-text" style="color: #ff6b6b;">${weatherData.description}</div>
                    <div class="small-text">${userSettings.city}</div>
                `;
            } else {
                weatherCard.innerHTML = `
                    <h3>Weather</h3>
                    <div class="large-text weather-temp">${weatherData.temp}</div>
                    <div class="medium-text">${weatherData.description}</div>
                    <div class="small-text">${userSettings.city}</div>
                `;
            }
        }

        function updateSunCard() {
            const now = new Date();
            const sunCard = document.getElementById('sunCard');
            
            // Calculate approximate sunrise/sunset (simplified)
            const month = now.getMonth();
            const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
            
            // Very rough approximation for mid-latitudes
            const sunriseBase = 6 + Math.sin((dayOfYear - 81) * 2 * Math.PI / 365) * 1.5;
            const sunsetBase = 18 - Math.sin((dayOfYear - 81) * 2 * Math.PI / 365) * 1.5;
            
            const sunrise = new Date(now);
            sunrise.setHours(Math.floor(sunriseBase), (sunriseBase % 1) * 60);
            
            const sunset = new Date(now);
            sunset.setHours(Math.floor(sunsetBase), (sunsetBase % 1) * 60);
            
            // Moon phase calculation
            const moonPhases = ['🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘'];
            const moonIndex = Math.floor(((now.getDate() - 1) / 29.5) * 8) % 8;
            
            sunCard.innerHTML = `
                <h3>Sun & Moon</h3>
                <div class="medium-text">🌅 ${sunrise.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                <div class="medium-text">🌇 ${sunset.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                <div class="medium-text">${moonPhases[moonIndex]} Moon</div>
            `;
        }

        function updateTimezoneCard() {
            const now = new Date();
            const timezoneCard = document.getElementById('timezoneCard');
            
            const timezones = [
                { name: 'LA', tz: 'America/Los_Angeles' },
                { name: 'NYC', tz: 'America/New_York' },
                { name: 'London', tz: 'Europe/London' },
                { name: 'Tokyo', tz: 'Asia/Tokyo' }
            ];
            
            const timezoneHTML = timezones.map(tz => {
                const time = new Date().toLocaleTimeString('en-US', {
                    timeZone: tz.tz,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `<div class="timezone-item"><span>${tz.name}</span><span>${time}</span></div>`;
            }).join('');
            
            timezoneCard.innerHTML = `
                <h3>Time Zones</h3>
                ${timezoneHTML}
            `;
        }

        function updateHolidayCard() {
            const now = new Date();
            const holidayCard = document.getElementById('holidayCard');
            
            // Simple holiday/special day detection
            const month = now.getMonth() + 1;
            const day = now.getDate();
            
            const holidays = {
                '1-1': '🎉 New Year\'s Day',
                '2-14': '💕 Valentine\'s Day',
                '3-17': '🍀 St. Patrick\'s Day',
                '4-1': '😄 April Fools\' Day',
                '5-5': '🇲🇽 Cinco de Mayo',
                '7-4': '🇺🇸 Independence Day',
                '10-31': '🎃 Halloween',
                '11-11': '🎖️ Veterans Day',
                '12-25': '🎄 Christmas Day'
            };
            
            const dateKey = `${month}-${day}`;
            const holiday = holidays[dateKey];
            
            if (holiday) {
                holidayCard.innerHTML = `
                    <h3>Today's Special</h3>
                    <div class="holiday-badge">${holiday}</div>
                `;
            } else {
                // Random "National Day" for fun
                const nationalDays = [
                    '🍕 Pizza Day', '📚 Reading Day', '🌳 Tree Day', '🐱 Cat Day',
                    '☕ Coffee Day', '🎵 Music Day', '🌮 Taco Day', '🍪 Cookie Day'
                ];
                const randomDay = nationalDays[day % nationalDays.length];
                
                holidayCard.innerHTML = `
                    <h3>Today's Special</h3>
                    <div class="medium-text">${randomDay}</div>
                    <div class="small-text">Celebrate something!</div>
                `;
            }
        }

        function updateProgressCard() {
            const now = new Date();
            const progressCard = document.getElementById('progressCard');
            
            // Day progress (0-100%)
            const totalMinutes = 24 * 60;
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const dayProgress = (currentMinutes / totalMinutes) * 100;
            
            // Week progress
            const dayOfWeek = now.getDay(); // 0 = Sunday
            const weekProgress = (dayOfWeek / 7) * 100;
            
            progressCard.innerHTML = `
                <h3>Day Progress</h3>
                <div class="small-text">Day: ${Math.round(dayProgress)}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${dayProgress}%"></div>
                </div>
                <div class="small-text">Week: ${Math.round(weekProgress)}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${weekProgress}%"></div>
                </div>
            `;
        }

        function updateStatsCard() {
            const now = new Date();
            const statsCard = document.getElementById('statsCard');
            
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const dayOfYear = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24)) + 1;
            
            const daysInYear = new Date(now.getFullYear(), 11, 31).getDate() === 31 ? 365 : 366;
            const weekOfYear = Math.ceil(dayOfYear / 7);
            
            statsCard.innerHTML = `
                <h3>Quick Stats</h3>
                <div class="medium-text">Day ${dayOfYear} of ${daysInYear}</div>
                <div class="small-text">Week ${weekOfYear}</div>
                <div class="small-text">${Math.round((dayOfYear/daysInYear)*100)}% through year</div>
            `;
        }

        function updateNewsCard() {
            const newsCard = document.getElementById('newsCard');
            
            // Trump administration dates
            const inaugurationDate = new Date('2025-01-20'); // January 20, 2025
            const endDate = new Date('2029-01-20'); // January 20, 2029
            const now = new Date();
            
            // Calculate days
            const totalDays = Math.floor((endDate - inaugurationDate) / (1000 * 60 * 60 * 24));
            const daysInto = Math.floor((now - inaugurationDate) / (1000 * 60 * 60 * 24));
            const daysLeft = Math.floor((endDate - now) / (1000 * 60 * 60 * 24));
            const percentComplete = Math.max(0, Math.min(100, (daysInto / totalDays) * 100));
            
            // Handle cases before/after the term
            if (now < inaugurationDate) {
                const daysUntilStart = Math.floor((inaugurationDate - now) / (1000 * 60 * 60 * 24));
                newsCard.innerHTML = `
                    <h3>Administration</h3>
                    <div class="medium-text">Starts in ${daysUntilStart} days</div>
                    <div class="small-text">January 20, 2025</div>
                `;
            } else if (now > endDate) {
                newsCard.innerHTML = `
                    <h3>Administration</h3>
                    <div class="medium-text">Term Completed</div>
                    <div class="small-text">Ended ${Math.abs(daysLeft)} days ago</div>
                `;
            } else {
                newsCard.innerHTML = `
                    <h3>Administration</h3>
                    <div class="medium-text">Day ${daysInto.toLocaleString()}</div>
                    <div class="small-text">${daysLeft.toLocaleString()} days left</div>
                    <div class="small-text">${percentComplete.toFixed(1)}% complete</div>
                    <div class="progress-bar" style="margin-top: 8px;">
                        <div class="progress-fill" style="width: ${percentComplete}%"></div>
                    </div>
                `;
            }
        }

        function updateScheduleCard() {
            const now = new Date();
            const currentTime = now.toLocaleTimeString();
            const currentPeriod = getCurrentPeriod();
            const display = document.getElementById('display');
            const timeDisplay = document.getElementById('currentTime');
            
            updateBackgroundColor(currentPeriod);
            
            if (!currentPeriod) {
                display.innerHTML = '<div class="before-after">Unknown</div>';
                timeDisplay.textContent = currentTime;
                return;
            }

            if (currentPeriod.type === 'before') {
                display.innerHTML = '<div class="before-after">Before</div>';
                timeDisplay.textContent = currentTime;
            } 
            else if (currentPeriod.type === 'after') {
                display.innerHTML = '<div class="before-after">After</div>';
                timeDisplay.textContent = currentTime;
            }
            else if (currentPeriod.type === 'passing') {
                const endMinutes = timeToMinutes(currentPeriod.end);
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const currentSeconds = now.getSeconds();
                const totalSecondsLeft = (endMinutes - currentMinutes) * 60 - currentSeconds;
                
                display.innerHTML = `
                    <div class="status">Passing</div>
                    <div class="countdown">${formatCountdown(totalSecondsLeft)} to START</div>
                    <div class="next-info">Next: ${currentPeriod.next}</div>
                `;
                timeDisplay.textContent = currentTime;
            }
            else if (currentPeriod.type === 'period') {
                const endMinutes = timeToMinutes(currentPeriod.end);
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const currentSeconds = now.getSeconds();
                const totalSecondsLeft = (endMinutes - currentMinutes) * 60 - currentSeconds;
                const minutesLeft = Math.floor(totalSecondsLeft / 60);
                
                if (minutesLeft <= 15) {
                    display.innerHTML = `
                        <div class="status">${currentPeriod.name}</div>
                        <div class="countdown">${formatCountdown(totalSecondsLeft)} to END</div>
                    `;
                    timeDisplay.textContent = currentTime;
                } else {
                    display.innerHTML = `
                        <div class="period-info">${getDayName()}</div>
                        <div class="status">${currentPeriod.name}</div>
                        <div class="weather-info">
                            <span class="weather-temp">${weatherData.temp}</span>
                            <span>${weatherData.description}</span>
                        </div>
                    `;
                    timeDisplay.textContent = `${formatCountdown(totalSecondsLeft)} to end`;
                }
            }
        }

        // Settings UI functions (same as before)
        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            document.getElementById('cityInput').value = userSettings.city;
            document.getElementById('dynamicCardsToggle').checked = userSettings.dynamicCards;
            generateScheduleInputs();
        }
        
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
            clearMessages();
        }
        
        function clearMessages() {
            document.getElementById('scheduleError').style.display = 'none';
            document.getElementById('weatherError').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function generateScheduleInputs() {
            const container = document.getElementById('scheduleInputs');
            const periods = userSettings.schedule.filter(p => p.type === 'period');
            
            container.innerHTML = periods.map(period => `
                <div class="period-input">
                    <label>${period.name}:</label>
                    <input type="time" value="${period.start}" data-period="${period.name}" data-field="start">
                    <span>to</span>
                    <input type="time" value="${period.end}" data-period="${period.name}" data-field="end">
                </div>
            `).join('');
        }
        
        function applyPreset(presetKey) {
            if (PRESET_SCHEDULES[presetKey]) {
                clearMessages();
                userSettings.schedule = JSON.parse(JSON.stringify(PRESET_SCHEDULES[presetKey].schedule));
                generateScheduleInputs();
                updateDateCard(); // Update date card to show new schedule type immediately
                
                const successMsg = document.getElementById('successMessage');
                successMsg.textContent = `${PRESET_SCHEDULES[presetKey].name} applied! Click Save to confirm.`;
                successMsg.style.display = 'block';
            }
        }
        
        function validateSchedule(periods) {
            const errors = [];
            const sortedPeriods = [...periods].sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
            
            for (let i = 0; i < sortedPeriods.length; i++) {
                const period = sortedPeriods[i];
                const startMin = timeToMinutes(period.start);
                const endMin = timeToMinutes(period.end);
                
                if (startMin >= endMin) {
                    errors.push(`${period.name} ends before or at the same time it starts`);
                }
                
                if (i < sortedPeriods.length - 1) {
                    const nextPeriod = sortedPeriods[i + 1];
                    const nextStartMin = timeToMinutes(nextPeriod.start);
                    
                    if (endMin > nextStartMin) {
                        errors.push(`${period.name} overlaps with ${nextPeriod.name}`);
                    }
                }
                
                if (endMin - startMin < 5) {
                    errors.push(`${period.name} is too short (less than 5 minutes)`);
                }
                
                if (endMin - startMin > 120) {
                    errors.push(`${period.name} is very long (more than 2 hours)`);
                }
            }
            
            return errors;
        }

        function saveSettings() {
            clearMessages();
            
            const newCity = document.getElementById('cityInput').value || 'New York, NY';
            const newDynamicCards = document.getElementById('dynamicCardsToggle').checked;
            const tempSchedule = [...userSettings.schedule];
            const inputs = document.querySelectorAll('#scheduleInputs input');
            
            inputs.forEach(input => {
                const periodName = input.dataset.period;
                const field = input.dataset.field;
                const period = tempSchedule.find(p => p.name === periodName);
                if (period && input.value) {
                    period[field] = input.value;
                }
            });
            
            const periods = tempSchedule.filter(p => p.type === 'period');
            const scheduleErrors = validateSchedule(periods);
            
            if (scheduleErrors.length > 0) {
                const errorMsg = document.getElementById('scheduleError');
                errorMsg.innerHTML = '<strong>Schedule Errors:</strong><br>' + scheduleErrors.join('<br>');
                errorMsg.style.display = 'block';
                return;
            }
            
            userSettings.city = newCity;
            userSettings.dynamicCards = newDynamicCards;
            userSettings.schedule = tempSchedule;
            
            const lastPeriod = userSettings.schedule.filter(p => p.type === 'period').pop();
            const afterSchool = userSettings.schedule.find(p => p.type === 'after');
            if (lastPeriod && afterSchool) {
                afterSchool.start = lastPeriod.end;
            }
            
            const savedSuccessfully = saveSettingsToStorage();
            
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = savedSuccessfully ? 
                'Settings saved successfully!' : 
                'Settings saved for this session (localStorage unavailable)';
            successMsg.style.display = 'block';
            
            // Apply card color setting immediately
            applyCardColorSetting();
            
            // If city changed, fetch new weather and update weather card
            fetchWeather().then(() => {
                updateWeatherCard();
            });
            updateDateCard(); // Update date card to show new schedule type
            
            setTimeout(() => {
                closeSettings();
            }, 2000);
        }
        
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                clearSavedSettings();
                userSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
                applyCardColorSetting(); // Apply default card setting
                openSettings();
                fetchWeather().then(() => {
                    updateWeatherCard();
                });
                updateDateCard(); // Update date card to show schedule type
                
                const successMsg = document.getElementById('successMessage');
                successMsg.textContent = 'All settings have been reset to defaults!';
                successMsg.style.display = 'block';
            }
        }
        
        function exportSettings() {
            try {
                const exportData = {
                    version: APP_VERSION,
                    exported: new Date().toISOString(),
                    settings: userSettings
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `school-dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                const successMsg = document.getElementById('successMessage');
                successMsg.textContent = 'Settings exported successfully!';
                successMsg.style.display = 'block';
                
            } catch (error) {
                const errorMsg = document.getElementById('scheduleError');
                errorMsg.textContent = 'Error exporting settings: ' + error.message;
                errorMsg.style.display = 'block';
            }
        }
        
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (importData.settings && importData.settings.city && importData.settings.schedule) {
                            userSettings = importData.settings;
                            // Ensure dynamicCards setting exists, default to true if not present
                            if (typeof userSettings.dynamicCards !== 'boolean') {
                                userSettings.dynamicCards = true;
                            }
                            saveSettingsToStorage();
                            applyCardColorSetting(); // Apply imported card setting
                            openSettings();
                            fetchWeather().then(() => {
                                updateWeatherCard();
                            });
                            updateDateCard(); // Update date card to show schedule type
                            
                            const successMsg = document.getElementById('successMessage');
                            successMsg.textContent = 'Settings imported successfully!';
                            successMsg.style.display = 'block';
                        } else {
                            throw new Error('Invalid settings file format');
                        }
                    } catch (error) {
                        const errorMsg = document.getElementById('scheduleError');
                        errorMsg.textContent = 'Error importing settings: ' + error.message;
                        errorMsg.style.display = 'block';
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Main update function
        function updateAllCards() {
            updateDateCard();
            updateWeatherCard();
            updateSunCard();
            updateTimezoneCard();
            updateHolidayCard();
            updateProgressCard();
            updateStatsCard();
            updateNewsCard(); // Administration tracker
            updateScheduleCard();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeSettings();
            } else if (event.key === 's' && (event.ctrlKey || event.metaKey)) {
                event.preventDefault();
                openSettings();
            }
        });

        // Initialize application
        function initializeApp() {
            loadSettings();
            fetchWeather().then(() => {
                updateWeatherCard(); // Update weather card after initial fetch
            });
            updateAllCards();
            
            // Update schedule every second, other cards every minute
            setInterval(updateScheduleCard, 1000);
            setInterval(() => {
                updateDateCard();
                updateWeatherCard(); // Add weather card to regular updates
                updateSunCard();
                updateTimezoneCard();
                updateProgressCard();
                updateStatsCard();
                updateNewsCard(); // Update administration tracker daily
            }, 60000);
            
            // Update weather every 10 minutes
            setInterval(() => {
                fetchWeather().then(() => {
                    updateWeatherCard(); // Update weather card immediately when new data arrives
                });
            }, 600000);
        }

        // Start the application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
